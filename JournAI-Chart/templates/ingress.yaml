{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "journai.fullname" . }}
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "journai.labels" . | nindent 4 }}
  annotations:
    # AWS Specific Annotations
    kubernetes.io/ingress.class: alb
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    
    #  转拽 1: 住驻转 驻专 443 (HTTPS)  砖 -ALB
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
    
    #  转拽 2: 专转 驻注转 Redirect 拽注 (301) -HTTP -HTTPS
    # 砖 'redirect-to-https' 砖砖 砖 -Backend -Path '/'
    alb.ingress.kubernetes.io/actions.redirect-to-https: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'

    {{- if .Values.ingress.certificateArn }}
    # -ARN 砖 转注 -ACM 注专 Listener 驻专 443
    alb.ingress.kubernetes.io/certificate-arn: {{ .Values.ingress.certificateArn | quote }}
    {{- end }}
    
    {{- if .Values.ingress.host }}
    # External DNS integration
    external-dns.alpha.kubernetes.io/hostname: {{ .Values.ingress.host }}
    {{- end }}
    
    # Health check and WAF settings (砖专 驻 砖)
    alb.ingress.kubernetes.io/healthcheck-path: /health
    alb.ingress.kubernetes.io/healthcheck-protocol: HTTP
    alb.ingress.kubernetes.io/healthcheck-interval-seconds: '15'
    alb.ingress.kubernetes.io/healthcheck-timeout-seconds: '5'
    alb.ingress.kubernetes.io/healthy-threshold-count: '2'
    alb.ingress.kubernetes.io/unhealthy-threshold-count: '2'
    
    {{- if .Values.ingress.webAclId }}
    alb.ingress.kubernetes.io/wafv2-acl-arn: {{ .Values.ingress.webAclId | quote }}
    {{- end }}
    
spec:
  rules:
    {{- if .Values.ingress.host }}
    - host: {{ .Values.ingress.host | quote }}
      http:
        paths:
          # API routes - direct to backend service
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: {{ include "journai.fullname" . }}-backend
                port:
                  number: {{ .Values.backend.service.port }}
          # Health check endpoint
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: {{ include "journai.fullname" . }}-backend
                port:
                  number: {{ .Values.backend.service.port }}
          
          #  转拽 3:  转 专砖 (/) 驻 驻注转 -REDIRECT
          # 专拽 专 -Redirect, 转注 转注 砖 -ALB 转转 -API/Frontend 专 HTTPS.
          - path: /
            pathType: Prefix
            backend:
              service:
                name: redirect-to-https # <--- 砖砖 砖 驻注 砖专 -Annotation
                port:
                  number: 80 # 驻专  (-ALB 转注  驻注转 Redirect)
    {{- else }}
      # ... (砖专 驻 砖 -  转 拽专 砖 专 host)
    - http:
        paths:
          # API routes - direct to backend service
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: {{ include "journai.fullname" . }}-backend
                port:
                  number: {{ .Values.backend.service.port }}
          # Health check endpoint
          - path: /health
            pathType: Prefix
            backend:
              service:
                name: {{ include "journai.fullname" . }}-backend
                port:
                  number: {{ .Values.backend.service.port }}
          # All other routes - direct to frontend for client-side routing
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{ include "journai.fullname" . }}-frontend
                port:
                  number: {{ .Values.frontend.service.port }}
    {{- end }}
    
  # 专转 -TLS -Ingress (, 砖专 驻 砖)
  #   砖-ALB Controller  砖 
  {{- if and .Values.ingress.tls .Values.ingress.host }}
  tls:
    - hosts:
        - {{ .Values.ingress.host | quote }}
      {{- if .Values.ingress.tlsSecretName }}
      secretName: {{ .Values.ingress.tlsSecretName }}
      {{- end }}
  {{- end }}
{{- end }}